---
title: "DESCO - Knowledge Discovery"
author: "1141074 - Sérgio Silva | 1040706 - Sérgio Castro | 1970400 - Pedro Neves"

date: "5/3/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Clean Environment
rm(list = ls())
```


The	 RFM	 (recency,	 frequency	 and	 monetary)	 model	 is	 the	 most	 widely	 used	 to	characterize customers	 because	 of its	 simplicity	and	good	 predictive	 capabilities.	 "Recency"	 represents	 the	time	since	the	last	purchase,	a	lower	value	corresponding	to	a	higher	probability	of	the	customer	making	a	repeat	 purchase.	 "Frequency"	 denotes	 the	 number	 of	 purchases	 within	 a	 specified	 time	 period;	 higher	frequency	indicates	higher	loyalty.	"Monetary"	means	 the	amount	of	money	spent	over this	specified	 time	period,	a	higher	value	indicates a	customer	that	the	company	should	focus on [2].	

Loading of the tables to create model RFM
```{r}
library(data.table)

keycols <- c('Store', 'Date', 'Time', 'TransactionID')

transactions = fread('DATA-CRM/TRANSACTION.dat')
setkeyv(transactions, keycols)

trans_items = fread('DATA-CRM/TRANSACTION_ITEM.dat')
setkeyv(trans_items, keycols)

```

Fazer 'join' das duas tabelas e remover observações contendo datas inválidas
```{r}
Result <- merge(transactions, trans_items, all = TRUE)

Result[, Date := as.Date(as.character.Date(Date),"%Y%m%d")]
Result <- na.omit(Result, cols = "Date")
```

Gerar RFM Score com package rfm
Calcula 'Recency', 'Frequency' e 'Monetary' a partir duma tabela de transações
```{r}
library(rfm)
analysis_date <- Sys.Date()

orders <- Result[, .(CardID, Date, Amount)]
rfm_result <- rfm_table_order(orders, CardID, Date, Amount, analysis_date)

View(rfm_result$rfm)
```


Cálculo "Manual" das três dimensões do RFM
```{r}
# Frequency
rfm_requency <- Result[, .N, by = CardID]

# Monetary
rfm_monetary <- Result[ , .(Total = sum(Amount)), by = CardID]

# Recency
rfm_recency <- Result[, .(LatestOrder = max(Date)), by = CardID][, .(Recency = analysis_date - LatestOrder), by = CardID]
```


# Confirmar se se pode utilizar aquele package ou tem de se gerar a pontuação RFM segundo o método descrito em "A review of the application of RFM model. African Journal of Business Management" ([2] da referências do enunciado)
